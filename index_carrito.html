<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
  
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
  
    <!-- Bootstrap-->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://getbootstrap.com/docs/5.2/assets/css/docs.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Latest compiled and minified CSS 3.4 -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css" />
  
    <!--Icono Bootstrap-->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.3/font/bootstrap-icons.css" />
  
    <?!= include('estiloCarrito'); ?>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg ">
          <div class="container-fluid">
    
            <a class="navbar-brand" style="font-size: 13px;"><img class="icono_persona"
                src="https://e7.pngegg.com/pngimages/290/731/png-clipart-computer-icons-user-username-avatar-person.png"
                alt="logo_persona"> Cliente</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
              aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
              <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarSupportedContent">
              <ul class="navbar-nav me-auto mb-2 mb-lg-0 align-items-center">
                <li class="nav-item">
                  <button id="btn_carta" class="nav-link btn_barra badge b_badge" type="button">Carta</button>
                </li>
                <li class="nav-item">
                  <a class="nav-link"><span class="badge b_badge ">Pedido</span></a>
                </li>
                <li class="nav-item">
                  <button id="btn_carrito" class="nav-link position-relative btn_barra badge b_badge" type="button">Carrito
                    <span id="count" class="count badge translate-middle">
                      0
                    </span>
                  </button>
    
                </li>
              </ul>
            </div>
          </div>
        </nav>
      </header>

    <!--carritooo-->
    <div id="bloqueCarrito" style="display: block;">
        <div class="Lista_Carrito">
            <table class="table table-striped jss562">
                <thead>
                    <tr class="table_row">
                        <th class="estilo_celda">Producto</th>
                        <th class="estilo_celda">Descripcion</th>
                        <th class="estilo_celda">Precio/Unidad</th>
                        <th class="estilo_celda">Cantidad</th>
                        <th class="estilo_celda">Monto General</th>
                        <th class="estilo_celda"></th>
                    </tr>
                </thead>
                <tbody id="shop-cart">

                    <!-- <tr>
            <td><img class="imagen_tabla" src="https://portal.andina.pe/EDPfotografia3/Thumbnail/2019/09/28/000623004W.jpg" alt="plato"></td>
            <td>Chancho al palo </td>
            <td>S/ 30</td>
            <td><div class="BtnCTabla">  
              <div class="botonContadorTabla">
                <button  class="operadorMenos btn" type="button" >-</button>
                <input  type="text" size="25" value="0" class="cantidadTabla" min="1" readonly="readonly" />
                <button  class="operadorMas btn" type="button" >+</button>
              </div>
            </div></td>
            <td><input class="input_carrito" type="text" value="0" readonly></td>
            <td><i class="basura bi bi-trash3"></i></td>
          </tr>
          <tr>
            <td><img class="imagen_tabla" src="https://i.ytimg.com/vi/U8UTf19AVGA/maxresdefault.jpg" alt="plato"></td>
            <td>Calamares </td>
            <td>S/ 45</td>
            <td><div class="BtnCTabla">  
              <div class="botonContadorTabla">
                <button  class="operadorMenos btn" type="button" >-</button>
                <input  type="text" size="25" value="0" class="cantidadTabla" min="1" readonly="readonly" />
                <button  class="operadorMas btn" type="button" >+</button>
              </div>
            </div></td>
            <td><input class="input_carrito" type="text" value="0" readonly></td>
            <td><i class="basura bi bi-trash3"></i></td>
          </tr> -->
                </tbody>
            </table>

        
        </div>
        </br>
        </br>
        <div style="display: none;" id="resumC" class="resumen_compra">
            <div class="forma_compra row">
                <div class="col-6">
                    <p class="fs-3">Monto Total:</p>

                </div>
                <div class="col-6">
                    <input id="montT" class="monto_compra" type="text" value="0" readonly/>
                </div>
                
            </div>

            <div class="btn_r_c">
                <button class="btn btn-success" type="button">Realizar Compra</button>
            </div>

        </div>

    </div>

    <!--==================================================--->

    <!-- jQuery library -->
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.1/jquery.min.js"></script>
  <!-- Latest compiled JavaScript -->
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.4.1/js/bootstrap.min.js"></script>

  <script>
    const btnCarta = document.getElementById("btn_carta")
    btnCarta.onclick = () => {
      // localStorage.clear();
      window.open(<?= url ?>, '_top')
    }
  </script>  

    <script>
      
        //carrito

let shopcart = document.getElementById('shop-cart')
//datos del sheet



var datas = []

    var basket = JSON.parse(localStorage.getItem("data")) || [];
///=================================================================

let calculations = () => {
    let cartIcon = document.getElementById("count");
    let search = basket.map(x => x)
    // console.log(search.length)
    cartIcon.innerHTML = search.length



    // let mapeo = basket.map(x => x.item)
    // cartIcon.innerHTML = mapeo.reduce((x, y) => x + y, 0)
}



calculations()


//   google.script.run.withSuccessHandler(data => {
// datas.push(...[data.proyectos])

// }).dataFood();

//render


// google.script.run.withSuccessHandler(data => {

// basket.map((b) => {
//     let {id,item} = b
//     // console.log(obj);
//     let search =data.proyectos.find( y => y.id === id) || [];
//     const html = `<tr>
//         <td><img class="imagen_tabla" src="${search.img}" alt="plato"></td>
//         <td>${search.nomb}</td>
//         <td>S/ ${search.prec}</td>
//         <td><div class="BtnCTabla">  
//           <div class="botonContadorTabla">
//             <button onclick="decrement(${id})"  class="operadorMenos btn" type="button" >-</button>
//             <input id="${id}"  type="text"  value="${item}" class="cantidadTabla"  readonly="readonly" />
//             <button   class="operadorMas btn" type="button" onclick="increment(${id})" >+</button>
//           </div>
//         </div></td>
//         <td><input class="input_carrito" type="text" value="${item * search.prec}" readonly></td>
//         <td><i onclick="removeItem(${id})"  class="basura bi bi-trash3"></i></td>
//       </tr>`;
//       shopcart.innerHTML += html;

//   })
// }).dataFood();

const renderBasCart = () => {

  google.script.run.withSuccessHandler(data => {
  if (basket.length !==0) {
   
    document.getElementById('resumC').style.display = "block";
    return (shopcart.innerHTML = basket

            .map(x =>{
                // console.log(x)
              
                let {id,item} =x ;
                let search =data.proyectos.find( y => y.id === id) || [];
            return `<tr>
        <td><img class="imagen_tabla" src="${search.img}" alt="plato"></td>
        <td>${search.nomb}</td>
        <td>S/ ${search.prec}</td>
        <td><div class="BtnCTabla">  
          <div class="botonContadorTabla">
            <button onclick="decrement(${id})"  class="operadorMenos btn" type="button" >-</button>
            <input id="${id}"  type="text"  value="${item}" class="cantidadTabla"  readonly="readonly" />
            <button   class="operadorMas btn" type="button" onclick="increment(${id})" >+</button>
          </div>
        </div></td>
        <td><input class="input_carrito" type="text" value="S/ ${item * search.prec}" readonly></td>
        <td><i onclick="removeItem(${id})"  class="basura bi bi-trash3"></i></td>
      </tr>`
      
        }).join(""));

        
    }
    else {
      shopcart.innerHTML = `<h2 class="text-align-center">Carrito está vació</h2>`
    document.getElementById('resumC').style.display = "none";

     
    }
  }).dataFood();
    }

    renderBasCart()
  
// console.log(datas);
//============================================================================

const increment = (id) => {
    let idinput = id
let search = basket.find(x => x.id === idinput.id)
if (search === undefined) {
    basket.push({
        id: id,
        item: 1
    })
}

else {
    search.item += 1;
}

renderBasCart()
update(idinput.id)
localStorage.setItem('data', JSON.stringify(basket))
// console.log(idinput)

// console.log(idinput.id)
}

const decrement = (id) => {
  let idinput = id
    let search = basket.find(x => x.id === idinput.id)
    if (search === undefined) return;

    else if (search.item === 0) return;

    else {
        search.item -= 1;
    }

    // console.log(basket)

    update(idinput.id)
    basket = basket.filter(x => x.item !== 0)
    renderBasCart()
    calculations()
    
    localStorage.setItem('data', JSON.stringify(basket))


}

const update = (id) => {

let search = basket.find(x => x.id === id)
// console.log(search.item)
document.getElementById(id).value = search.item;

calculations()
TotalAmount()
// console.log(search)

};

const removeItem = (id) => {
  let idinput = id
basket=basket.filter(x => x.id !== idinput.id )
// console.log(id)
TotalAmount()
renderBasCart()
calculations()

localStorage.setItem("data",JSON.stringify(basket))

}

let TotalAmount = () => {
  const label = document.getElementById("montT")
  google.script.run.withSuccessHandler(data => {
    if (basket.length !== 0) {
      
        let amount = basket.map(x => {
            let {item , id } = x
            let search =data.proyectos.find( y => y.id === id) || [];
            return item * search.prec;
        }).reduce((x,y) => x + y,0)
        // console.log(amount)
        label.value =  amount ;

      
    } 
    
    
    else return label.value =  "0" ;

  }).dataFood();
};

TotalAmount();




    </script>

</body>

</html>